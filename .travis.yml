sudo: required
language: C++

matrix:

  include:

  - env: PG=9.3/2.3
    addons:
      postgresql: 9.3
      apt:
        packages:
        - postgresql-9.3
        - postgresql-9.3-pgtap
        - postgresql-server-dev-9.3
        - postgresql-9.3-postgis-2.3

  - env: PG=9.4/2.3
    addons:
      postgresql: 9.4
      apt:
        packages:
        - postgresql-9.4
        - postgresql-9.4-pgtap
        - postgresql-server-dev-9.4
        - postgresql-9.4-postgis-2.3

  - env: PG=9.5/2.3
    addons:
      postgresql: 9.5
      apt:
        packages:
        - postgresql-9.5
        - postgresql-9.5-pgtap
        - postgresql-server-dev-9.5
        - postgresql-9.5-postgis-2.3

  - env: PG=9.6/2.3
    addons:
      postgresql: 9.6
      apt:
        packages:
        - postgresql-9.6
        - postgresql-9.6-pgtap
        - postgresql-server-dev-9.6
        - postgresql-9.6-postgis-2.3

before_install:
  # Install common packages
  - sudo apt-get -qq update
  - sudo apt-get install -y pgtap
    debhelper fakeroot
  # Enable fetching packages from packagecloud
  # test and production repositories
  - curl -s https://packagecloud.io/install/repositories/linz/test/script.deb.sh | sudo bash
  - curl -s https://packagecloud.io/install/repositories/linz/prod/script.deb.sh | sudo bash
  # Install postgresql-tableversion
  - sudo apt-get install postgresql-`echo $PG | cut -d/ -f1`-tableversion
  # Install dbpatch
  - sudo apt-get install postgresql-`echo $PG | cut -d/ -f1`-dbpatch
  # Install linz-bde-schema
  - sudo apt-get install linz-bde-schema
  # Install linz-bde-uploader
  - sudo apt-get install linz-bde-uploader
script:
  - make
  - make check || { cat regression.diffs; false; }
  - sudo env "PATH=$PATH" make install
  - make installcheck
  # stdout support requires:
  #   - dbpatch-1.4.0
  #   - linz-bde-uploader-2.5.0
  - make installcheck-stdout
  # Build docs
  ## Install docs generation dependencies
  - sudo apt-get install -y wkhtmltopdf xvfb
  - wget https://github.com/jgm/pandoc/releases/download/2.1.1/pandoc-2.1.1-1-amd64.deb
  - sudo dpkg -i pandoc-2.1.1-1-amd64.deb
  ## Build the docs
  - xvfb-run make docs
  ## TODO: check docs quality ?
  # Test build and installation of debian package
  - make deb
  - sudo dpkg -i ../linz-lds-bde-schema*.deb
