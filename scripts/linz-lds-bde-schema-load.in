#!/bin/sh

DB_NAME=
export SKIP_INDEXES=no
export EXTENSION_MODE=on
export PSQL=psql
export SCRIPTSDIR=/usr/share/linz-lds-bde-schema/sql/

SQLSCRIPTS="@@SQLSCRIPTS@@"

if test -n "${LDSBDESCHEMA_SQLDIR}"; then
    SCRIPTSDIR=${LDSBDESCHEMA_SQLDIR}
fi

if test ! -f "${SCRIPTSDIR}/01-lds_layer_tables.sql"; then
    cat >&2 <<EOF
Cannot find 01-lds_layer_tables.sql in ${SCRIPTSDIR}
Please set LDSBDESCHEMA_SQLDIR environment variable
EOF
    exit 1
fi

while test -n "$1"; do
    if test $1 = "--noindexes"; then
        SKIP_INDEXES=yes
        shift; continue
    elif test "$1" = "--version"; then
        echo "@@VERSION@@ @@REVISION@@"
        exit 0
    elif test $1 = "--noextension"; then
        EXTENSION_MODE=off
        shift; continue
    else
        DB_NAME=$1; shift
    fi
done

if test -z "$DB_NAME"; then
    echo "Usage: $0 [--noextension] <database>" >&2
    echo "       $0 --version" >&2
    exit 1
fi

# Load linz-bde-uploader schema
# guess where linz-bde-uploader-schema-load could be
PATH="$PATH:$HOME/perl5/bin";
LOADER=linz-bde-uploader-schema-load
which $LOADER > /dev/null || {
    echo "$0 depends on $LOADER, which cannot be found in current PATH." >&2
    echo "Did you install linz-bde-uploader ? (2.4.0 or later needed)" >&2
    exit 1
}

OPTS=
if test "${EXTENSION_MODE}" = "off"; then
    OPTS="--noextension"
fi
${LOADER} ${OPTS} $DB_NAME || {
    echo "${LOADER} exited with an error" >&2
    exit 1
}

export PGDATABASE=$DB_NAME
(
cat << EOF
CREATE EXTENSION IF NOT EXISTS unaccent SCHEMA public;
EOF

for file in $SQLSCRIPTS; do
    if test `dirname $file` = 'sql/versioning'; then
        continue
    fi
    #echo "DOING $file" >&2
    file=${SCRIPTSDIR}/`echo $file | sed 's|sql/||'`
    cat ${file}
done

if test "${ADD_REVISIONS}" = "yes"; then
    for file in $SQLSCRIPTS; do
        if test `dirname $file` = 'sql/versioning'; then
            #echo "DOING (versioning) $file" >&2
            file=${SCRIPTSDIR}/`echo $file | sed 's|sql/||'`
            cat ${file}
        fi
    done

    file=${SCRIPTSDIR}/versioning/01-version_tables.sql
    cat ${file} || exit 1
fi

) | $PSQL -tA --set ON_ERROR_STOP=1
